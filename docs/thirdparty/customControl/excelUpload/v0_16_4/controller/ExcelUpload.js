"use strict";sap.ui.define(["sap/ui/core/Fragment","sap/m/MessageToast","cc/excelUpload/v0_16_4/thirdparty/xlsx","./MetadataHandler","../types","./odata/ODataV2","./odata/ODataV4","./Util","./Parser","./ErrorHandler","./Preview","sap/base/Log","sap/ui/model/json/JSONModel","./Options"],function(t,e,a,s,o,i,n,r,l,h,d,c,p,g){function u(t){return t&&t.__esModule&&typeof t.default!=="undefined"?t.default:t}const f=u(s);const y=o["ErrorTypes"];const m=u(i);const w=u(n);const b=u(r);const x=u(l);const H=u(h);const C=u(d);const S=u(g);class O{constructor(t,e){this.dialog=null;this.errorState=false;this.UI5MinorVersion=sap.ui.version.split(".")[1];this.component=t;this.componentI18n=e;this.util=new b(e.getResourceBundle());this.isODataV4=this._checkIfODataIsV4();this.isOpenUI5=sap.ui.generic?false:true;this.odataHandler=this.getODataHandler(this.UI5MinorVersion);this.initialSetupPromise=this.initialSetup();this.previewHandler=new C(this.util)}async initialSetup(){this.optionsHandler=new S(this);const e=new p({dataRows:0,strict:this.component.getStrict()});if(!this.dialog){this.dialog=await t.load({name:"cc.excelUpload.v0_16_4.fragment.ExcelUpload",type:"XML",controller:this});this.dialog.setModel(this.componentI18n,"i18n");this.dialog.setModel(e,"info");this.dialog.setModel(this.component.getModel("device"),"device")}if(this.component.getStandalone()&&this.component.getColumns().length===0){this.dialog.getSubHeader().setVisible(false);this.dialog.getSubHeader().getContentLeft()[0].setVisible(false)}this.errorHandler=new H(this);if(!this.component.getStandalone()){this.metadataHandler=new f(this);this.odataHandler.metaDatahandler=this.metadataHandler;try{await this.setContext();this.errorState=false}catch(t){this.errorMessage=t;this.errorState=true}}}async setContext(){this.context=this.component.getContext();if(this.context.base){this.context=this.context.base}this.view=this.odataHandler.getView(this.context);this.tableObject=this.odataHandler.getTableObject(this.component.getTableId(),this.view);this.component.setTableId(this.tableObject.getId());this.binding=this.odataHandler.getBinding(this.tableObject);if(!this.binding){throw new Error(this.util.geti18nText("bindingError"))}const t=this.odataHandler.getOdataType(this.binding,this.tableObject,this.component.getOdataType());this.component.setOdataType(t);this.odataKeyList=await this.odataHandler.getKeyList(t,this.tableObject);this.typeLabelList=await this.odataHandler.createLabelList(this.component.getColumns(),t,this.tableObject);this.model=this.tableObject.getModel();try{const t=await this._loadDraftController();this.odataHandler.draftController=new t(this.model,undefined)}catch(t){}}getODataHandler(t){if(this.isODataV4){return new w(t)}else{return new m(t)}}async openExcelUploadDialog(){await this.initialSetupPromise;if(this.errorState){await this.initialSetup()}if(!this.errorState){this.dialog.getContent()[0].getItems()[1].clear();this.dialog.open()}else{b.showError(this.errorMessage,"ExcelUpload.ts","initialSetup");c.error("ErrorState: True. Can not open dialog.","ExcelUpload.ts.openExcelUploadDialog")}}async showPreview(){this.previewHandler.showPreview(this.payloadArray)}async onFileUpload(t){try{this.errorHandler.setErrorResults([]);const e=t.getParameter("files")[0];const s=await this._readWorkbook(e);const o=s.SheetNames[0];let i=a.utils.sheet_to_row_object_array(s.Sheets[o]);let n=a.utils.sheet_to_json(s.Sheets[o],{header:1})[0];if(!i||i.length===0){throw new Error(this.util.geti18nText("emptySheet"))}for(const t of i){for(const e in t){t[e]=typeof t[e]==="string"?t[e].trim():t[e]}}if(!this.component.getStandalone()){this.errorHandler.checkMandatoryColumns(i,n,this.odataKeyList,this.component.getMandatoryFields(),this.typeLabelList);this.errorHandler.checkColumnNames(n,this.component.getFieldMatchType(),this.typeLabelList)}this.payload=i;this.component.fireCheckBeforeRead({sheetData:i});if(!this.component.getStandalone()){this.payloadArray=[];this.payloadArray=x.parseExcelData(this.payload,this.typeLabelList,this.component,this.errorHandler,this.util)}else{this.payloadArray=this.payload}if(this.errorHandler.areErrorsPresent()){this.errorHandler.displayErrors();return}this.setDataRows()}catch(t){b.showError(t,"ExcelUpload.ts","onFileUpload");this.resetContent()}}onCloseDialog(){this.resetContent();this.dialog.close()}onOpenOptionsDialog(){this.optionsHandler.openOptionsDialog()}async onUploadSet(t){const a=this.component.fireUploadButtonPress({payload:this.payload});if(!a||this.component.getStandalone()){this.onCloseDialog();return}if(!this.payloadArray.length){e.show(this.util.geti18nText("selectFileUpload"));return}var s=this;const o=t.getSource();const i=o.getParent();i.setBusyIndicatorDelay(0);i.setBusy(true);await b.sleep(50);var n=function(){return new Promise((t,e)=>{s.callOdata(t,e)})};var r={busy:{set:true,check:false},dataloss:{popup:true,navigation:false},sActionLabel:this.util.geti18nText("uploadingFile")};if(this.isODataV4){await this.context.editFlow.securedExecution(n,r)}else{try{if(this.context.extensionAPI){await this.context.extensionAPI.securedExecution(n,r)}else{await n()}}catch(t){b.showError(t,"ExcelUpload.ts","onUploadSet");this.resetContent()}}i.setBusy(false);this.onCloseDialog()}async callOdata(t,e){try{const e=this.tableObject.getModel();const a=this.odataHandler.processPayloadArray(this.component.getBatchSize(),this.payloadArray);for(const t of a){for(const a of t){this.payload=a;this.component.fireChangeBeforeCreate({payload:this.payload});this.odataHandler.createAsync(e,this.binding,this.payload)}await this.odataHandler.waitForCreation(e);if(this.component.getActivateDraft()){await this.odataHandler.waitForDraft()}this.odataHandler.resetContexts()}try{this.binding.refresh()}catch(t){c.error(t)}t()}catch(t){this.odataHandler.resetContexts();c.error(t);e(t)}}onTempDownload(){let t=this.component.getFieldMatchType();var s=[{}];if(this.component.getStandalone()){for(let t of this.component.getColumns()){s[0][t]=""}}else{for(let[e,a]of Object.entries(this.typeLabelList)){if(t==="label"){s[0][a.label]=""}if(t==="labelTypeBrackets"){s[0][`${a.label}[${e}]`]=""}}}const o=a.utils.json_to_sheet(s);const i=a.utils.book_new();a.utils.book_append_sheet(i,o,"Tabelle1");a.writeFile(i,this.component.getExcelFileName());e.show(this.util.geti18nText("downloadingTemplate"))}_checkIfODataIsV4(){try{if(this.component.getContext().getModel().getODataVersion()==="4.0"){return true}}catch(t){return false}}_setPayload(t){this.payload=t}async buffer_RS(t){const e=[];const a=t.getReader();for(;;){const t=await a.read();if(t.value)e.push(t.value);if(t.done)break}const s=new Uint8Array(e.reduce((t,e)=>t+e.length,0));let o=0;for(const t of e){s.set(t,o);o+=t.length}return s}async _readWorkbook(t){return new Promise(async(e,s)=>{try{const s=await this.buffer_RS(t.stream());let o=a.read(s);e(o)}catch(t){s(t)}})}async _loadDraftController(){return new Promise(function(t,e){sap.ui.require(["sap/ui/generic/app/transaction/DraftController"],function(e){t(e)},function(t){e(t)})})}resetContent(){this.payloadArray=[];this.payload=[];this.dialog.getModel("info").setProperty("/dataRows",0);this.odataHandler.resetContexts();var t=this.dialog.getContent()[0].getItems()[1];t.setValue()}getErrorResults(){return this.errorHandler.getErrorResults()}addToErrorsResults(t){t.forEach(t=>{if(t.group){t.type=y.CustomErrorGroup}else{t.type=y.CustomError}t.counter=1});this.errorHandler.addToErrorsResults(t)}setDataRows(){this.dialog.getModel("info").setProperty("/dataRows",this.payloadArray.length)}}return O});
//# sourceMappingURL=ExcelUpload.js.map